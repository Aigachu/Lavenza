#!/usr/bin/env node

// Modules.
const arp = require('app-root-path');
const minimist = require('minimist');
const ncp = require('ncp');
const colors = require('colors');
const prompt = require('prompt-async');

// Configure colors.
colors.setTheme({
  silly: 'rainbow',
  input: 'grey',
  verbose: 'cyan',
  prompt: 'grey',
  success: 'cyan',
  data: 'grey',
  help: 'cyan',
  status: 'blue',
  warning: 'yellow',
  debug: 'blue',
  error: 'red'
});

// Grab provided arguments using minimist.
const argv = minimist(process.argv.slice(2));

// Process the command!
processArguments(argv).then(() => {
  process.exit(1);
});

/**
 * Process the 'lavenza' command line arguments.
 *
 * @TODO - Roadmap
 *    -> Add code that will generate a .gitignore for those that setup Lavenza. (.env files must be ignored at all times)
 *    -> Add code that will handle the generation of bots at will (i.e. lavenza create bot)
 *    -> Add code that will handle the generation of talents at will (i.e. lavenza create talent)
 *    -> Add code that will handle the generation of commands at will (i.e. lavenza create command)
 *    -> Add code that will handle the generation of listeners at will (i.e. lavenza create listener)
 *
 * @param {Object} args
 *   Arguments supplied with the command, parsed with minimist.
 */
async function processArguments(args) {
  // For now we just want simple management of ONE command.
  if (argv['_'][0] === 'setup') {
    // Flavor text.
    // @ts-ignore
    console.log(`Lavenza: Commencing installation!.`.success);

    // Get the intended destination directory to initiate the Desk at.
    let installDestination;

    // We prompt the user to tell us where to place it.
    await prompt.start();
    console.log(`Lavenza: Installation files for the framework must reside in a directory within your project.`);
    const {installDestinationInput} = await prompt.get({
      properties: {
        installDestinationInput: {
          description: `Enter the desired path for Lavenza's installation in your project`,
          type: 'string',
          default: 'lavenza',
        }
      }
    });
    installDestination = installDestinationInput;

    // If the destination directory doesn't exist, we want to cancel and shoot an error.
    // @TODO

    // Copy the base Desk to the provided path.
    await copyFilesAsync(`${arp.path}/templates/installation`, installDestination).catch((err) => {
      console.log(err);
    });
    // @ts-ignore
    console.log(`Lavenza: Successfully initialized a Desk with the appropriate folder structure at '${installDestination}'. Refer to the README.md file found in that folder to begin configuring Lavenza!`.success);
  }
}

/**
 * Copy files to a destination, asynchronously.
 *
 * Returns a promise that can be awaited.
 *
 * @param {string} source
 *   Source files to copy.
 * @param {string} destination
 *   Destination to copy these files to.
 */
function copyFilesAsync(source, destination) {
  return new Promise((resolve, reject) => {
    ncp(source, destination, {
      clobber: false,
      stopOnErr: true
    }, async (err) => {
      if (err) {
        reject(err);
      }
      resolve();
    });
  });
}
